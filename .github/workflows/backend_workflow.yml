name: Register container and deploy

on:
   push:
      paths: [backend/**, .github/workflows/backend_workflow.yml, '!**.md', '!**.MD']
      branches:
         - main 

concurrency:
   group: ${{ github.workflow }}-${{ github.ref }}
   cancel-in-progress: true

jobs:
   test__build__and__push__image:
      runs-on: ubuntu-22.04
      permissions:
         contents: write
      defaults:
         run:
            working-directory: backend
      steps:
         - uses: actions/checkout@v4
           with:
            sparse-checkout: backend
            fetch-depth: 0
         - uses: actions/setup-java@v4
           with:
            distribution: 'temurin'
            java-version: '17'
         - name: Initialize test
           run: ./gradlew clean test
         - name: Build and push image
           run: ./gradlew bootBuildImage -PDOCKER_PASS="${{ secrets.DOCKER_PASS }}" -PDOCKER_TAG=$(git rev-parse --short ${{ github.sha }})

   #build-and-deploy:
   #   runs-on: ubuntu-latest
   #   steps:
   #   - uses: actions/checkout@main
   #     with:
   #      sparse-checkout: backend
   #      fetch-depth: 0
   #   - name: 'Build and push image'
   #     uses: azure/docker-login@v1
   #     with:
   #      login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
   #      username: ${{ secrets.REGISTRY_USERNAME }}
   #      password: ${{ secrets.REGISTRY_PASSWORD }}
   #   - run: |
   #      docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/bank:latest \
   #         --build-arg CLIENT=${{ secrets.CLIENT }} --build-arg EMAIL=${{ secrets.EMAIL }} --build-arg PASSWORD="${{ secrets.EMAIL_PASSWORD }}" \
   #         --build-arg KEY=${{ secrets.JWT_KEY }} --build-arg ISSUER=${{ secrets.JWT_ISSUER }} --build-arg DB_URL=${{ secrets.DB_URL }} \
   #         --build-arg DB_NAME=${{ secrets.DB_NAME }} --build-arg DB_PASS=${{ secrets.DB_PASS }} backend/
   #         
   #      docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/bank:latest